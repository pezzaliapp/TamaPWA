<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TamaPWA â€” Single-file v16</title>
<link rel="manifest" href="manifest.json">
<style>
:root{--bg:#0d1117;--panel:#111827;--muted:#9aa0a6;--fg:#eaeaf0;--acc:#46b478;--bad:#b84d4d}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
main,header{max-width:980px;margin:0 auto;padding:12px}
header{display:flex;justify-content:space-between;align-items:center;gap:6px;flex-wrap:wrap}
h1{font-size:18px;margin:0}
.badge{font-size:12px;color:var(--muted)}
button{background:#19202c;color:var(--fg);border:1px solid #2b2f3a;border-radius:10px;padding:8px 12px;cursor:pointer}
button.primary{outline:2px solid #2b2f3a}
#pet{display:grid;place-items:center;height:320px;background:var(--panel);border-radius:14px;border:1px solid #2b2f3a}
#petImg{width:192px;height:192px;image-rendering:pixelated}
#meta{color:var(--muted);font-size:12px}
#stats{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:12px}
.card{background:var(--panel);border:1px solid #2b2f3a;border-radius:12px;padding:6px}
.bar{height:6px;background:#161b26;border-radius:12px;overflow:hidden}
.bar>i{display:block;height:100%;background:linear-gradient(90deg,var(--acc),#7cf3a0)}
#toasts{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:9999}
.toast{padding:8px 12px;border:1px solid #2b2f3a;background:#1a1c22;border-radius:10px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
dialog{border:1px solid #2b2f3a;border-radius:12px;background:#0f1420;color:var(--fg);max-width:640px}
/* Sequence */
#seqBoard{ display:grid; grid-template-columns: repeat(2,120px); grid-template-rows: repeat(2,120px); gap:12px; justify-content:center; margin: 12px 0; }
.q{ width:120px; height:120px; border-radius:12px; border:2px solid #2b2f3a; user-select:none; touch-action:manipulation; position:relative; }
.q span{ position:absolute; inset:0; display:grid; place-items:center; font-size:42px; font-weight:800; color:rgba(0,0,0,.35); }
.q1{ background:#d33; } .q2{ background:#3d3; } .q3{ background:#36f; } .q4{ background:#dd3; }
.q.active{ filter:brightness(2); }
.q.disabled{ opacity:.45; border-style:dashed; pointer-events:none }
#seqBoard.symbols .q1{ background:#4a4a4a; }
#seqBoard.symbols .q2{ background:#595959; }
#seqBoard.symbols .q3{ background:#686868; }
#seqBoard.symbols .q4{ background:#777777; }
#seqBoard.symbols .q span{ color:#eaeaf0; font-size:48px; }
/* Reflex */
#reflexArea{position:relative;width:min(520px,95vw);height:220px;margin:12px auto;border:1px dashed #2b2f3a;border-radius:10px;background:#0f1320;display:grid;place-items:center;font-size:26px;font-weight:700;user-select:none;touch-action:manipulation}
#reflexArea.ready{background:#202432}
#reflexArea.go{background:#1f3d1f}
#reflexArea.early{background:#3d1f1f}
#reflexHUD{display:flex;justify-content:space-between;align-items:center;width:min(520px,95vw);margin:0 auto}
</style>
</head>
<body>
<header>
  <h1>TamaPWA â€” Single-file <span class="badge">v16</span></h1>
  <div class="right">
    <button id="feed">ğŸ Nutri</button>
    <button id="catch">ğŸ¯ Catch!</button>
    <button id="reflex">âš¡ Reflex</button>
    <button id="sequence">ğŸŸ¥ğŸŸ©ğŸŸ¦ğŸŸ¨ Sequence</button>
    <button id="sleep">ğŸ˜´ Dormi</button>
    <button id="clean">ğŸ§¼ Pulisci</button>
    <button id="sound">ğŸ”Š Suoni: ON</button>
    <button id="demo">â±ï¸ Demo: OFF</button>
    <button id="install">â¬‡ï¸ Installa</button>
    <button id="resetCache">â™»ï¸ Reset cache</button>
  </div>
</header>

<main>
  <section id="pet">
    <img id="petImg" alt="sprite" src="data:image/svg+xml;utf8,<?xml version='1.0' encoding='UTF-8'?><svg xmlns='http://www.w3.org/2000/svg' width='192' height='192'><rect width='100%' height='100%' fill='%23101826'/><rect x='56' y='52' width='80' height='96' rx='8' fill='%237cf3a0'/><circle cx='84' cy='88' r='6'/><circle cx='120' cy='88' r='6'/><rect x='96' y='110' width='28' height='8' fill='%23161b26'/></svg>"/>
  </section>
  <p id="meta">EtÃ : <b id="age">0g</b> â€” Stadio: <b id="stage">Uovo</b> â€” Umore: <b id="mood">Curioso</b></p>
  <div id="stats">
    <div class="card"><div>Fame</div><div class="bar"><i id="bH" style="width:40%"></i></div></div>
    <div class="card"><div>FelicitÃ </div><div class="bar"><i id="bHa" style="width:50%"></i></div></div>
    <div class="card"><div>Energia</div><div class="bar"><i id="bE" style="width:60%"></i></div></div>
    <div class="card"><div>Pulizia</div><div class="bar"><i id="bC" style="width:60%"></i></div></div>
    <div class="card"><div>Salute</div><div class="bar"><i id="bHe" style="width:80%"></i></div></div>
  </div>
</main>

<div id="toasts"></div>

<!-- Reflex -->
<dialog id="gReflex">
  <h3>âš¡ Reflex Tap</h3>
  <p class="muted small">Premi START, aspetta <b>GO!</b> e tocca il pannello il piÃ¹ velocemente possibile (5 round).</p>
  <div id="reflexArea" aria-label="Reflex area">Prontoâ€¦</div>
  <div id="reflexHUD">
    <span>Round: <b id="rRound">0</b>/5</span>
    <span>Tempo: <b id="rTime">â€”</b> ms (Best: <b id="rBest">â€”</b>)</span>
    <button id="startReflex" class="primary">Start</button>
  </div>
  <form method="dialog"><button>Chiudi</button></form>
</dialog>

<!-- Sequence -->
<dialog id="gSequence">
  <h3>ğŸŸ¥ğŸŸ©ğŸŸ¦ğŸŸ¨ Sequence</h3>
  <p class="muted small">Guarda la sequenza e ripetila <b>nellâ€™ordine</b>. Puoi passare ai <b>simboli</b> se preferisci.</p>
  <div class="muted small" style="display:flex;gap:10px;justify-content:space-between;align-items:center;">
    <label><input type="checkbox" id="seqSymbols"> Simboli</label>
    <label><input type="checkbox" id="seqDebug"> Debug</label>
  </div>
  <div id="seqDebugStrip" class="muted small" style="display:none"></div>
  <div id="seqBoard">
    <button class="q q1" data-q="1"><span>â– </span></button>
    <button class="q q2" data-q="2"><span>â– </span></button>
    <button class="q q3" data-q="3"><span>â– </span></button>
    <button class="q q4" data-q="4"><span>â– </span></button>
  </div>
  <div id="seqHUD">
    <span>Round: <b id="seqRound">0</b></span>
    <span>Stato: <b id="seqStatus">â€”</b></span>
    <button id="startSequence" class="primary">Start</button>
  </div>
  <form method="dialog"><button>Chiudi</button></form>
</dialog>

<script>
const $=s=>document.querySelector(s);
const toastWrap=$('#toasts');
function toast(msg){ const el=document.createElement('div'); el.className='toast'; el.textContent=msg; toastWrap.appendChild(el); setTimeout(()=>{el.style.opacity='0';el.style.transform='translateY(6px)';},1400); setTimeout(()=>el.remove(),1800); }

// State
const S=JSON.parse(localStorage.getItem('tama')||'{}');
if(!S.init){ Object.assign(S,{init:true,h:40,ha:50,e:60,c:60,he:80,last:Date.now(),soundOn:true,demo:false,sleep:false,scores:{sequenceBest:0,reflexBest:null,catchBest:0}}); save(); }
function save(){ localStorage.setItem('tama', JSON.stringify(S)); }
function clamp(x,a,b){return Math.max(a,Math.min(b,x));}

// Audio
let ctx;
function getCtx(){ if(!ctx) ctx=new (window.AudioContext||window.webkitAudioContext)(); return ctx; }
function beep(freq=440,dur=120,type='square',vol=0.28){ if(!S.soundOn) return; const c=getCtx(); const o=c.createOscillator(), g=c.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=vol; o.connect(g).connect(c.destination); o.start(); o.stop(c.currentTime+dur/1000); }
['pointerdown','touchstart','click','keydown'].forEach(ev=>window.addEventListener(ev,async()=>{ try{ const c=getCtx(); if(c.state==='suspended') await c.resume(); const b=c.createBuffer(1,1,22050); const s=c.createBufferSource(); s.buffer=b; s.connect(c.destination); s.start(0);}catch{} },{once:true,passive:true}));

// Elements
const petImg=$('#petImg'), ageEl=$('#age'), stageEl=$('#stage'), moodEl=$('#mood');
const bH=$('#bH'), bHa=$('#bHa'), bE=$('#bE'), bC=$('#bC'), bHe=$('#bHe');
const feedBtn=$('#feed'), cleanBtn=$('#clean'), sleepBtn=$('#sleep'), soundBtn=$('#sound'), demoBtn=$('#demo'), installBtn=$('#install'), resetCacheBtn=$('#resetCache');
const catchBtn=$('#catch'), reflexBtn=$('#reflex'), seqBtn=$('#sequence');

// Buttons
soundBtn.onclick=()=>{ S.soundOn=!S.soundOn; soundBtn.textContent=S.soundOn?'ğŸ”Š Suoni: ON':'ğŸ”ˆ Suoni: OFF'; save(); if(S.soundOn){ beep(660,120);} };
demoBtn.onclick=()=>{ S.demo=!S.demo; demoBtn.textContent=S.demo?'â±ï¸ Demo: ON':'â±ï¸ Demo: OFF'; save(); };
installBtn.onclick=async()=>{ try{ await navigator.serviceWorker.register('service-worker.js'); toast('PWA installata/aggiornata'); }catch{ toast('Impossibile installare SW'); } };
resetCacheBtn.onclick=async()=>{ try{ if('serviceWorker' in navigator){ const regs=await navigator.serviceWorker.getRegistrations(); for(const r of regs){ await r.unregister(); } } if('caches' in window){ const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k))); } }catch{} location.reload(true); };

feedBtn.onclick=()=>{ if(S.sleep){S.sleep=false;} S.h=clamp(S.h+28,0,100); S.c=clamp(S.c-4,0,100); beep(520); render(); save(); toast('ğŸ Fame +28 / Pulizia -4'); };
cleanBtn.onclick=()=>{ if(S.sleep){S.sleep=false;} S.c=clamp(S.c+30,0,100); beep(760); render(); save(); toast('ğŸ§¼ Pulizia +30'); };
sleepBtn.onclick=()=>{ if(!S.sleep){S.sleep=true; toast('ğŸ˜´ Dorme');} else { S.sleep=false; toast('â˜€ï¸ Sveglia'); } save(); render(); };

function render(){ bH.style.width=S.h+'%'; bHa.style.width=S.ha+'%'; bE.style.width=S.e+'%'; bC.style.width=S.c+'%'; bHe.style.width=S.he+'%'; sleepBtn.textContent=S.sleep?'â˜€ï¸ Sveglia':'ğŸ˜´ Dormi'; }
render();

// Tick
const DECAY={h:2,ha:1.5,e:2,c:1};
setInterval(()=>{
  const now=Date.now(); let dt=(now-S.last)/1000; if(dt<=0){S.last=now;return;}
  let dh=dt/3600; if(document.hidden) dh*=0.25;
  if(!S.sleep){ S.h=clamp(S.h-DECAY.h*dh,0,100); S.ha=clamp(S.ha-DECAY.ha*dh,0,100); S.e=clamp(S.e-DECAY.e*dh,0,100); S.c=clamp(S.c-DECAY.c*dh,0,100); }
  else { S.e=clamp(S.e+5*dh,0,100); if(S.e>=95) S.sleep=false; }
  S.last=now; save(); render();
},1000);

// ===== Mini Catch! super semplice (punteggio) =====
catchBtn.onclick=()=>{ const pts=Math.floor(Math.random()*20+5); const gain=Math.min(10,Math.floor(pts/3)); const cost=3; const food=Math.min(5,Math.floor(pts/6)); S.ha=clamp(S.ha+gain,0,100); S.e=clamp(S.e-cost,0,100); S.h=clamp(S.h+food,0,100); if(pts>(S.scores.catchBest||0)){ S.scores.catchBest=pts; toast('ğŸ† Record Catch: '+pts); } save(); render(); toast('ğŸ¯ Catch: +Fel '+gain+' / -En '+cost + (food? ' / +Fame '+food : '')); beep(620,140); setTimeout(()=>beep(740,140),160); };

// ===== Reflex =====
const dlgReflex=$('#gReflex'), startReflex=$('#startReflex'), reflexArea=$('#reflexArea');
const rRoundEl=$('#rRound'), rTimeEl=$('#rTime'), rBestEl=$('#rBest');
reflexBtn.onclick=()=>{ dlgReflex.showModal(); reflexArea.className='ready'; reflexArea.textContent='Prontoâ€¦'; rRoundEl.textContent='0'; rTimeEl.textContent='â€”'; rBestEl.textContent=(S.scores.reflexBest==null?'â€”':S.scores.reflexBest); };
let rRound=0, rBest=S.scores.reflexBest, rStart=0, rState='idle', rTimeout=null;
startReflex.onclick=()=> startReflexGame();
function startReflexGame(){ clearTimeout(rTimeout); rRound=0; rBest=S.scores.reflexBest; nextReflexRound(); }
function nextReflexRound(){ rRound++; rRoundEl.textContent=String(rRound); if(rRound>5) return endReflexSeries(); rState='waiting'; reflexArea.className='ready'; reflexArea.textContent='Attendiâ€¦'; const delay=600+Math.random()*1800; rTimeout=setTimeout(()=>{ rState='go'; reflexArea.className='go'; reflexArea.textContent='GO! TAP!'; rStart=performance.now(); beep(800,90); },delay); }
reflexArea.addEventListener('pointerdown',(ev)=>{ ev.preventDefault(); if(rState==='waiting'){ reflexArea.className='early'; reflexArea.textContent='Troppo presto!'; beep(200,160); S.ha=clamp(S.ha-1,0,100); save(); render(); clearTimeout(rTimeout); setTimeout(nextReflexRound,700); } else if(rState==='go'){ const t=Math.round(performance.now()-rStart); rState='scored'; rTimeEl.textContent=String(t); rBest=(rBest==null)?t:Math.min(rBest,t); const improved=(S.scores.reflexBest==null)|| (rBest<S.scores.reflexBest); S.scores.reflexBest=rBest; const gain=t<=250?10:t<=350?7:t<=500?5:3; const food=gain>=7?3:gain>=5?2:1; S.ha=clamp(S.ha+gain,0,100); S.e=clamp(S.e-3,0,100); S.h=clamp(S.h+food,0,100); save(); render(); if(improved) toast('ğŸ† Record Reflex: '+rBest+' ms'); toast('âš¡ Reflex: +Fel '+gain+' / -En 3 / +Fame '+food); beep(620,120); setTimeout(()=>beep(740,120),140); setTimeout(nextReflexRound,700); } },{passive:false});
function endReflexSeries(){ rState='idle'; reflexArea.className='ready'; reflexArea.textContent='Serie finita! Best: '+(rBest==null?'â€”':rBest+' ms'); }

// ===== Sequence =====
const dlgSeq=$('#gSequence'), startSeq=$('#startSequence'), seqStatus=$('#seqStatus'), seqRoundEl=$('#seqRound'), seqBoard=$('#seqBoard'), seqSymbols=$('#seqSymbols'), seqDebug=$('#seqDebug'), seqDebugStrip=$('#seqDebugStrip');
seqBtn.onclick=()=>{ dlgSeq.showModal(); resetSeqUI(); updateSeqMode(); };
function updateSeqMode(){ if(!seqBoard) return; if (seqSymbols.checked){ seqBoard.classList.add('symbols'); const qs=seqBoard.querySelectorAll('.q'); if(qs.length>=4){ qs[0].querySelector('span').textContent='â–²'; qs[1].querySelector('span').textContent='â—†'; qs[2].querySelector('span').textContent='â—'; qs[3].querySelector('span').textContent='â– '; } } else { seqBoard.classList.remove('symbols'); seqBoard.querySelectorAll('.q').forEach(q=>q.querySelector('span').textContent='â– '); } }
if (seqSymbols) seqSymbols.addEventListener('change', updateSeqMode);
let seqState='idle', seq=[], seqIdx=0, seqRound=0, seqTimer=null, seqInputOpen=false, seqLastTs=0;
function seqLog(){ if(!seqDebug.checked){ seqDebugStrip.style.display='none'; return; } seqDebugStrip.style.display='block'; seqDebugStrip.textContent=`state=${seqState} | round=${seqRound} | idx=${seqIdx}/${seq.length} | seq=[${seq.join(',')}]`; }
function resetSeqUI(){ clearTimeout(seqTimer); seq=[]; seqIdx=0; seqRound=0; seqState='idle'; seqInputOpen=false; seqRoundEl.textContent='0'; seqStatus.textContent='â€”'; setQDisabled(true); startSeq.disabled=false; seqLog(); }
startSeq.onclick=()=> startSeqGame();
function startSeqGame(){ resetSeqUI(); seqStatus.textContent='Guarda la sequenza'; nextSeqRound(); }
function nextSeqRound(){ seqRound++; seqRoundEl.textContent=String(seqRound); seqIdx=0; seq.push(1+Math.random()*4|0); playSeq(); }
function playSeq(){ seqState='playback'; setQDisabled(true); seqInputOpen=false; seqLog(); startSeq.disabled=true; let i=0; const step=()=>{ if(i>=seq.length){ seqState='input'; setQDisabled(false); seqIdx=0; seqLog(); seqStatus.textContent='Tocca in ordine (1/'+seq.length+')'; setTimeout(()=>{seqInputOpen=true;},80); startSeq.disabled=false; return; } const val=seq[i], el=seqBoard.querySelector(`.q[data-q="${val}"]`); if(el){ el.classList.add('active'); setTimeout(()=>el.classList.remove('active'),220);} if(seqSymbols.checked){ beep([330,440,554,659][val-1],160);} else { beep([440,520,660,780][val-1],160);} i++; seqTimer=setTimeout(step,520); }; step(); }
function setQDisabled(d){ seqBoard.querySelectorAll('.q').forEach(q=>q.classList.toggle('disabled',!!d)); }
function colorName(v){ return seqSymbols.checked? ({1:'â–²',2:'â—†',3:'â—',4:'â– '}[v]):({1:'rosso',2:'verde',3:'blu',4:'giallo'}[v]); }
seqBoard.addEventListener('pointerup',(ev)=>{ const now=performance.now(); if(now-seqLastTs<120) return; seqLastTs=now; const btn=ev.target.closest('.q'); if(!btn) return; ev.preventDefault(); handleQ(Number(btn.dataset.q)); },{passive:false});
function handleQ(val){ if(seqState!=='input'||!seqInputOpen){ seqLog(); return; } const expected=seq[seqIdx]; const el=seqBoard.querySelector(`.q[data-q="${val}"]`); if(el){ el.classList.add('active'); setTimeout(()=>el.classList.remove('active'),180);} if(seqSymbols.checked){ beep([330,440,554,659][val-1],140);} else { beep([440,520,660,780][val-1],140);} if(val===expected){ seqIdx++; seqLog(); if(seqIdx<seq.length){ seqStatus.textContent='Tocca in ordine ('+(seqIdx+1)+'/'+seq.length+')'; } else { const gain=6, cost=3, food=Math.min(5, Math.floor(seq.length/2)); S.ha=clamp(S.ha+gain,0,100); S.e=clamp(S.e-cost,0,100); S.h=clamp(S.h+food,0,100); if(seqRound>(S.scores.sequenceBest||0)){ S.scores.sequenceBest=seqRound; toast('ğŸ† Record Sequence: Round '+seqRound+'!'); } save(); render(); toast('ğŸŸ¥ğŸŸ© Sequence: +Fel '+gain+' / -En '+cost + (food? ' / +Fame '+food : '')); seqStatus.textContent='Bravo! Prossimo round...'; seqState='idle'; seqInputOpen=false; setQDisabled(true); setTimeout(nextSeqRound,650);} } else { const prog=seqIdx; const gain=Math.min(4, prog>>1); const food=prog>=2?1:0; if(gain>0) S.ha=clamp(S.ha+gain,0,100); if(food>0) S.h=clamp(S.h+food,0,100); save(); render(); toast('âŒ Sequence: atteso '+colorName(expected)+', hai premuto '+colorName(val)+' â€” +'+(gain>0?('Fel '+gain):'0')+(food?' / +Fame '+food:'')); seqStatus.textContent='Errore! Round '+seqRound+' non completato.'; seqState='idle'; seqInputOpen=false; setQDisabled(true); beep(200,200,'square',0.25); setTimeout(()=>beep(160,220,'square',0.25),240);} }
</script>
</body>
</html>
